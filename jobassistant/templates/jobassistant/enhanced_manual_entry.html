{% extends 'base.html' %}
{% load static %}

{% block title %}Manual Job Entry Options - JobTailor{% endblock %}

{% block extra_css %}
<style>
    .entry-option-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        cursor: pointer;
        border: 2px solid transparent;
    }
    
    .entry-option-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-color: #007bff;
    }
    
    .entry-option-card.active {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    .option-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .form-section {
        display: none;
    }
    
    .form-section.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .linkedin-info {
        background: linear-gradient(135deg, #0077b5, #0066a2);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .smart-entry-info {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- Header -->
            <div class="text-center mb-4">
                <h2 class="display-6">Manual Job Entry Required</h2>
                <p class="lead text-muted">Automatic scraping encountered issues. Choose your preferred entry method below.</p>
            </div>
            
            <!-- Failed URL Info -->
            {% if failed_url %}
            <div class="alert alert-info mb-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <div>
                        <strong>Job URL:</strong> <code>{{ failed_url }}</code><br>
                        <strong>Reason:</strong> {{ failed_reason }}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- LinkedIn Specific Info -->
            {% if is_linkedin %}
            <div class="linkedin-info mb-4">
                <div class="d-flex align-items-center">
                    <i class="fab fa-linkedin me-3" style="font-size: 2rem;"></i>
                    <div>
                        <h5 class="mb-1">LinkedIn Job Detected</h5>
                        <p class="mb-0">For LinkedIn jobs, we recommend trying authenticated access for better results.</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Entry Method Options -->
            <div class="row mb-4">
                <!-- Manual Form Entry -->
                <div class="col-md-4 mb-3">
                    <div class="card entry-option-card h-100" onclick="selectEntryMethod('manual')" id="manual-option">
                        <div class="card-body text-center">
                            <div class="option-icon text-primary">
                                <i class="fas fa-keyboard"></i>
                            </div>
                            <h5 class="card-title">Manual Form Entry</h5>
                            <p class="card-text">Fill out structured form fields with job details step by step.</p>
                            <div class="mt-3">
                                <span class="badge bg-primary">Most Accurate</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Smart Paste + AI -->
                <div class="col-md-4 mb-3">
                    <div class="card entry-option-card h-100" onclick="selectEntryMethod('smart')" id="smart-option">
                        <div class="card-body text-center">
                            <div class="option-icon text-success">
                                <i class="fas fa-magic"></i>
                            </div>
                            <h5 class="card-title">Smart Paste + AI</h5>
                            <p class="card-text">Paste job content and let AI extract structured information automatically.</p>
                            <div class="mt-3">
                                <span class="badge bg-success">Fastest</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- LinkedIn Login (if applicable) -->
                {% if is_linkedin %}
                <div class="col-md-4 mb-3">
                    <div class="card entry-option-card h-100" onclick="selectEntryMethod('linkedin')" id="linkedin-option">
                        <div class="card-body text-center">
                            <div class="option-icon text-info">
                                <i class="fab fa-linkedin"></i>
                            </div>
                            <h5 class="card-title">LinkedIn Login</h5>
                            <p class="card-text">Login to LinkedIn for authenticated access and better extraction.</p>
                            <div class="mt-3">
                                <span class="badge bg-info">Best Quality</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Manual Form Entry Section -->
            <div id="manual-form-section" class="form-section">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-keyboard me-2"></i>
                            Manual Form Entry
                        </h4>
                        <p class="mb-0 text-muted">Fill out each field with the job posting details</p>
                    </div>
                    
                    <div class="card-body">
                        <form method="post" id="manualEntryForm">
                            {% csrf_token %}
                            <input type="hidden" name="failed_url" value="{{ failed_url }}">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                                    {{ form.title }}
                                    {% if form.title.help_text %}
                                    <div class="form-text">{{ form.title.help_text }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.company.id_for_label }}" class="form-label">{{ form.company.label }}</label>
                                    {{ form.company }}
                                    {% if form.company.help_text %}
                                    <div class="form-text">{{ form.company.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.location.id_for_label }}" class="form-label">{{ form.location.label }}</label>
                                    {{ form.location }}
                                    {% if form.location.help_text %}
                                    <div class="form-text">{{ form.location.help_text }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.employment_type.id_for_label }}" class="form-label">{{ form.employment_type.label }}</label>
                                    {{ form.employment_type }}
                                    {% if form.employment_type.help_text %}
                                    <div class="form-text">{{ form.employment_type.help_text }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.salary_range.id_for_label }}" class="form-label">{{ form.salary_range.label }}</label>
                                {{ form.salary_range }}
                                {% if form.salary_range.help_text %}
                                <div class="form-text">{{ form.salary_range.help_text }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                                {{ form.description }}
                                {% if form.description.help_text %}
                                <div class="form-text">{{ form.description.help_text }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.requirements.id_for_label }}" class="form-label">{{ form.requirements.label }}</label>
                                {{ form.requirements }}
                                {% if form.requirements.help_text %}
                                <div class="form-text">{{ form.requirements.help_text }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="{{ form.application_instructions.id_for_label }}" class="form-label">{{ form.application_instructions.label }}</label>
                                {{ form.application_instructions }}
                                {% if form.application_instructions.help_text %}
                                <div class="form-text">{{ form.application_instructions.help_text }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="resetSelection()">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Options
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Job Details
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Smart Entry Redirect Section -->
            <div id="smart-form-section" class="form-section">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-magic me-2"></i>
                            Smart Paste + AI Parsing
                        </h4>
                    </div>
                    
                    <div class="card-body">
                        <div class="smart-entry-info">
                            <h5 class="mb-2">How it works:</h5>
                            <ol class="mb-0">
                                <li>Go to the job posting page</li>
                                <li>Select all content (Ctrl+A)</li>
                                <li>Copy (Ctrl+C)</li>
                                <li>Paste in our smart form</li>
                                <li>AI extracts structured information automatically</li>
                            </ol>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="resetSelection()">
                                <i class="fas fa-arrow-left me-2"></i>Back to Options
                            </button>
                            <a href="{% url 'jobassistant:smart_manual_entry' %}?url={{ failed_url }}" class="btn btn-success">
                                <i class="fas fa-magic me-2"></i>Continue to Smart Entry
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- LinkedIn Login Redirect Section -->
            {% if is_linkedin %}
            <div id="linkedin-form-section" class="form-section">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fab fa-linkedin me-2"></i>
                            LinkedIn Authentication
                        </h4>
                    </div>
                    
                    <div class="card-body">
                        <div class="linkedin-info">
                            <h5 class="mb-2">Benefits of LinkedIn Login:</h5>
                            <ul class="mb-0">
                                <li>Access to complete job descriptions</li>
                                <li>Better company information</li>
                                <li>More accurate job requirements</li>
                                <li>Higher extraction success rate</li>
                            </ul>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-shield-alt me-2"></i>
                            <strong>Privacy Note:</strong> Your LinkedIn credentials are used only for this session and are not stored permanently.
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="resetSelection()">
                                <i class="fas fa-arrow-left me-2"></i>Back to Options
                            </button>
                            <a href="{% url 'jobassistant:linkedin_login_setup' %}?url={{ failed_url }}" class="btn btn-info">
                                <i class="fab fa-linkedin me-2"></i>Continue to LinkedIn Login
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Error Display -->
            {% if errors %}
            <div class="alert alert-danger mt-3">
                <h6>Please correct the following errors:</h6>
                <ul class="mb-0">
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
        </div>
    </div>
</div>

<script>
let selectedMethod = null;

function selectEntryMethod(method) {
    // Reset all options
    document.querySelectorAll('.entry-option-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Hide all form sections
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Activate selected option
    document.getElementById(method + '-option').classList.add('active');
    document.getElementById(method + '-form-section').classList.add('active');
    
    selectedMethod = method;
    
    // Scroll to form section
    document.getElementById(method + '-form-section').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}

function resetSelection() {
    // Reset all options
    document.querySelectorAll('.entry-option-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Hide all form sections
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });
    
    selectedMethod = null;
    
    // Scroll back to options
    document.querySelector('.row.mb-4').scrollIntoView({
        behavior: 'smooth',
        block: 'start'
    });
}

// Handle form submission
document.getElementById('manualEntryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    // Show loading state
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    submitBtn.disabled = true;
    
    fetch(this.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${data.message}
            `;
            
            this.parentNode.insertBefore(alert, this);
            
            // Redirect after a short delay
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 1500);
        } else {
            // Show error messages
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger';
            alert.innerHTML = `
                <h6>Please correct the following errors:</h6>
                <ul class="mb-0">
                    ${data.errors ? data.errors.map(error => `<li>${error}</li>`).join('') : `<li>${data.error || 'An error occurred'}</li>`}
                </ul>
            `;
            
            this.parentNode.insertBefore(alert, this);
            
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Show generic error
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            An error occurred while saving. Please try again.
        `;
        
        this.parentNode.insertBefore(alert, this);
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});
</script>
{% endblock %}
