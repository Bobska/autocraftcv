{% extends 'base.html' %}
{% load static %}

{% block title %}LinkedIn Login Setup - JobTailor{% endblock %}

{% block extra_css %}
<style>
    .linkedin-hero {
        background: linear-gradient(135deg, #0077b5, #0066a2);
        color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .benefit-card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
        height: 100%;
    }
    
    .benefit-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .benefit-icon {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #0077b5, #0066a2);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .security-info {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .login-form {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 2rem;
    }
    
    .session-indicator {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .warning-box {
        background: linear-gradient(45deg, #ffc107, #ff9800);
        color: #212529;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- LinkedIn Hero Section -->
            <div class="linkedin-hero text-center">
                <div class="mb-3">
                    <i class="fab fa-linkedin" style="font-size: 4rem;"></i>
                </div>
                <h2 class="display-6 mb-3">LinkedIn Authentication</h2>
                <p class="lead mb-0">Login to LinkedIn for enhanced job scraping and better data extraction</p>
            </div>
            
            <!-- Job URL Info -->
            {% if job_url %}
            <div class="alert alert-info mb-4">
                <div class="d-flex align-items-center">
                    <i class="fab fa-linkedin me-2"></i>
                    <div>
                        <strong>LinkedIn Job:</strong> <code>{{ job_url }}</code>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Benefits Section -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card benefit-card">
                        <div class="card-body text-center">
                            <div class="benefit-icon mx-auto">
                                <i class="fas fa-unlock-alt"></i>
                            </div>
                            <h6 class="card-title">Full Access</h6>
                            <p class="card-text small">Access complete job descriptions without authentication walls</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card benefit-card">
                        <div class="card-body text-center">
                            <div class="benefit-icon mx-auto">
                                <i class="fas fa-building"></i>
                            </div>
                            <h6 class="card-title">Better Company Info</h6>
                            <p class="card-text small">Extract detailed company information and insights</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card benefit-card">
                        <div class="card-body text-center">
                            <div class="benefit-icon mx-auto">
                                <i class="fas fa-list-ul"></i>
                            </div>
                            <h6 class="card-title">Complete Requirements</h6>
                            <p class="card-text small">Access full job requirements and qualifications</p>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card benefit-card">
                        <div class="card-body text-center">
                            <div class="benefit-icon mx-auto">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h6 class="card-title">Higher Success Rate</h6>
                            <p class="card-text small">95%+ extraction success rate with authentication</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Security Information -->
            <div class="security-info">
                <div class="d-flex align-items-start">
                    <i class="fas fa-shield-alt text-success me-3 mt-1" style="font-size: 1.5rem;"></i>
                    <div>
                        <h5 class="mb-2">Your Privacy & Security</h5>
                        <ul class="mb-0">
                            <li><strong>Session Only:</strong> Credentials are used only for this browsing session</li>
                            <li><strong>Not Stored:</strong> We do not permanently store your LinkedIn password</li>
                            <li><strong>Secure Connection:</strong> All communication is encrypted via HTTPS</li>
                            <li><strong>Limited Scope:</strong> Used only for job posting extraction</li>
                            <li><strong>Auto-Logout:</strong> Session expires when you close the browser</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Warning for 2FA Users -->
            <div class="warning-box">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-3"></i>
                    <div>
                        <strong>Two-Factor Authentication (2FA) Notice:</strong><br>
                        If you have 2FA enabled, you may need to complete additional verification steps. 
                        The process will pause for manual completion.
                    </div>
                </div>
            </div>
            
            <!-- Login Form -->
            <div class="login-form">
                <div class="session-indicator">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2"></i>
                        <div>
                            <strong>Session-Based Authentication</strong><br>
                            <small>Your credentials are used for this session only and automatically expire</small>
                        </div>
                    </div>
                </div>
                
                <form method="post" id="linkedinLoginForm">
                    {% csrf_token %}
                    <input type="hidden" name="job_url" value="{{ job_url }}">
                    
                    <div class="mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">
                            <i class="fas fa-envelope me-2"></i>{{ form.email.label }}
                        </label>
                        {{ form.email }}
                        {% if form.email.help_text %}
                        <div class="form-text">{{ form.email.help_text }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.password.id_for_label }}" class="form-label">
                            <i class="fas fa-lock me-2"></i>{{ form.password.label }}
                        </label>
                        <div class="input-group">
                            {{ form.password }}
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePassword()">
                                <i class="fas fa-eye" id="password-toggle-icon"></i>
                            </button>
                        </div>
                        {% if form.password.help_text %}
                        <div class="form-text">{{ form.password.help_text }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.save_credentials }}
                            <label class="form-check-label" for="{{ form.save_credentials.id_for_label }}">
                                {{ form.save_credentials.label }}
                            </label>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Credentials will be saved in your browser session for convenience but not stored permanently
                        </div>
                    </div>
                    
                    <!-- Expected Process Info -->
                    <div class="alert alert-info">
                        <h6>What happens next?</h6>
                        <ol class="mb-0 small">
                            <li>Secure login to LinkedIn using your credentials</li>
                            <li>Navigate to the job posting with authenticated access</li>
                            <li>Extract complete job details and requirements</li>
                            <li>Create job posting in your JobTailor account</li>
                            <li>Automatically logout and clear session</li>
                        </ol>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{% url 'jobassistant:enhanced_manual_entry' %}?url={{ job_url }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Manual Options
                        </a>
                        
                        <div>
                            <button type="submit" class="btn btn-primary btn-lg" id="login-btn">
                                <i class="fab fa-linkedin me-2"></i>Login & Extract Job
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Alternative Options -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-question-circle me-2"></i>
                        Prefer not to login?
                    </h6>
                    <p class="card-text text-muted">You can still extract job information using our alternative methods:</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <a href="{% url 'jobassistant:smart_manual_entry' %}?url={{ job_url }}" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-magic me-2"></i>Smart Paste + AI
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="{% url 'jobassistant:enhanced_manual_entry' %}?url={{ job_url }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-keyboard me-2"></i>Manual Form Entry
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Error Display -->
            {% if errors %}
            <div class="alert alert-danger mt-3">
                <h6>Please correct the following errors:</h6>
                <ul class="mb-0">
                    {% for error in errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
        </div>
    </div>
</div>

<script>
function togglePassword() {
    const passwordField = document.querySelector('input[name="password"]');
    const toggleIcon = document.getElementById('password-toggle-icon');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
    } else {
        passwordField.type = 'password';
        toggleIcon.className = 'fas fa-eye';
    }
}

// Handle form submission
document.getElementById('linkedinLoginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = document.getElementById('login-btn');
    const originalText = submitBtn.innerHTML;
    
    // Validate form
    const email = formData.get('email');
    const password = formData.get('password');
    
    if (!email || !password) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-warning mt-3';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            Please enter both your LinkedIn email and password.
        `;
        this.parentNode.insertBefore(alert, this.nextSibling);
        return;
    }
    
    // Show loading state with steps
    submitBtn.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <span>Connecting to LinkedIn...</span>
        </div>
    `;
    submitBtn.disabled = true;
    
    // Add progress indicator
    const progressAlert = document.createElement('div');
    progressAlert.className = 'alert alert-info mt-3';
    progressAlert.id = 'progress-alert';
    progressAlert.innerHTML = `
        <div class="d-flex align-items-center mb-2">
            <div class="spinner-border spinner-border-sm me-3" role="status"></div>
            <strong>LinkedIn Authentication in Progress...</strong>
        </div>
        <div class="progress mb-2" style="height: 8px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 style="width: 20%;" id="progress-bar"></div>
        </div>
        <small class="text-muted" id="progress-text">Establishing secure connection...</small>
    `;
    this.parentNode.insertBefore(progressAlert, this.nextSibling);
    
    // Simulate progress updates
    let progress = 20;
    const progressSteps = [
        { progress: 40, text: "Logging into LinkedIn..." },
        { progress: 60, text: "Navigating to job posting..." },
        { progress: 80, text: "Extracting job information..." },
        { progress: 95, text: "Processing and saving data..." }
    ];
    
    let stepIndex = 0;
    const progressInterval = setInterval(() => {
        if (stepIndex < progressSteps.length) {
            const step = progressSteps[stepIndex];
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar && progressText) {
                progressBar.style.width = step.progress + '%';
                progressText.textContent = step.text;
            }
            stepIndex++;
        }
    }, 2000);
    
    fetch(this.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(progressInterval);
        
        // Remove progress alert
        const progressAlert = document.getElementById('progress-alert');
        if (progressAlert) progressAlert.remove();
        
        if (data.success) {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success mt-3';
            alert.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>LinkedIn Authentication Successful!</strong>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <small><strong>Method Used:</strong> ${data.method_used || 'LinkedIn Authenticated'}</small><br>
                        <small><strong>Job ID:</strong> ${data.job_id}</small>
                    </div>
                    <div class="col-md-6">
                        <small><strong>Status:</strong> Successfully extracted</small><br>
                        <small><strong>Quality:</strong> High (authenticated)</small>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">Redirecting to job details...</small>
                </div>
            `;
            
            this.parentNode.insertBefore(alert, this.nextSibling);
            
            // Redirect after delay
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 2000);
            
        } else if (data.requires_manual_entry) {
            // LinkedIn auth failed, show manual options
            const alert = document.createElement('div');
            alert.className = 'alert alert-warning mt-3';
            alert.innerHTML = `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>LinkedIn Authentication Failed</strong>
                </div>
                <p class="mb-2">${data.message}</p>
                <div class="d-flex gap-2">
                    ${data.manual_entry_options.smart_entry ? 
                        `<a href="${data.manual_entry_options.smart_entry}" class="btn btn-success btn-sm">
                            <i class="fas fa-magic me-1"></i>Try Smart Entry
                        </a>` : ''}
                    ${data.manual_entry_options.manual_form ? 
                        `<a href="${data.manual_entry_options.manual_form}" class="btn btn-primary btn-sm">
                            <i class="fas fa-keyboard me-1"></i>Manual Form
                        </a>` : ''}
                </div>
            `;
            
            this.parentNode.insertBefore(alert, this.nextSibling);
            
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
        } else {
            // Show error messages
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger mt-3';
            alert.innerHTML = `
                <h6>LinkedIn Authentication Failed:</h6>
                <ul class="mb-2">
                    ${data.errors ? data.errors.map(error => `<li>${error}</li>`).join('') : `<li>${data.error || 'Authentication failed'}</li>`}
                </ul>
                <div class="mt-2">
                    <small class="text-muted">
                        Common issues: Incorrect credentials, 2FA required, or temporary LinkedIn restrictions.
                    </small>
                </div>
            `;
            
            this.parentNode.insertBefore(alert, this.nextSibling);
            
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        console.error('Error:', error);
        
        // Remove progress alert
        const progressAlert = document.getElementById('progress-alert');
        if (progressAlert) progressAlert.remove();
        
        // Show generic error
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger mt-3';
        alert.innerHTML = `
            <i class="fas fa-exclamation-triangle me-2"></i>
            An error occurred during LinkedIn authentication. Please try again or use alternative methods.
        `;
        
        this.parentNode.insertBefore(alert, this.nextSibling);
        
        // Reset button
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});
</script>
{% endblock %}
