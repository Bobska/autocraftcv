{% extends 'jobassistant/base.html' %}

{% block title %}Create CV - AutoCraftCV{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Page Header -->
            <div class="text-center mb-4">
                <h2 class="mb-3">
                    <i class="fas fa-user-plus text-primary"></i> Create Your Professional CV
                </h2>
                <p class="text-muted">
                    Follow our step-by-step wizard to create a comprehensive professional profile.
                </p>
            </div>

            <!-- Progress Indicator -->
            <div class="wizard-progress mb-5">
                <div class="row text-center">
                    <div class="col step-item {% if current_step <= 1 %}active{% elif current_step > 1 %}completed{% endif %}">
                        <a href="?step=1" class="step-link">
                            <div class="step-circle">
                                {% if current_step > 1 %}
                                    <i class="fas fa-check"></i>
                                {% else %}
                                    1
                                {% endif %}
                            </div>
                            <small class="step-label">Personal Info</small>
                        </a>
                    </div>
                    <div class="col step-item {% if current_step == 2 %}active{% elif current_step > 2 %}completed{% endif %}">
                        <a href="?step=2" class="step-link">
                            <div class="step-circle">
                                {% if current_step > 2 %}
                                    <i class="fas fa-check"></i>
                                {% else %}
                                    2
                                {% endif %}
                            </div>
                            <small class="step-label">Summary</small>
                        </a>
                    </div>
                    <div class="col step-item {% if current_step == 3 %}active{% elif current_step > 3 %}completed{% endif %}">
                        <a href="?step=3" class="step-link">
                            <div class="step-circle">
                                {% if current_step > 3 %}
                                    <i class="fas fa-check"></i>
                                {% else %}
                                    3
                                {% endif %}
                            </div>
                            <small class="step-label">Skills</small>
                        </a>
                    </div>
                    <div class="col step-item {% if current_step == 4 %}active{% elif current_step > 4 %}completed{% endif %}">
                        <a href="?step=4" class="step-link">
                            <div class="step-circle">
                                {% if current_step > 4 %}
                                    <i class="fas fa-check"></i>
                                {% else %}
                                    4
                                {% endif %}
                            </div>
                            <small class="step-label">Experience</small>
                        </a>
                    </div>
                    <div class="col step-item {% if current_step == 5 %}active{% elif current_step > 5 %}completed{% endif %}">
                        <a href="?step=5" class="step-link">
                            <div class="step-circle">
                                {% if current_step > 5 %}
                                    <i class="fas fa-check"></i>
                                {% else %}
                                    5
                                {% endif %}
                            </div>
                            <small class="step-label">Education</small>
                        </a>
                    </div>
                </div>
                <div class="progress mt-3">
                    <div class="progress-bar" 
                         role="progressbar" 
                         style="width: {% widthratio current_step 5 100 %}%"
                         aria-valuenow="{% widthratio current_step 5 100 %}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
            </div>

            <!-- Wizard Form -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-edit"></i> Step {{ current_step }}: {{ step_title }}
                    </h5>
                    <small class="opacity-75">{{ step_description }}</small>
                </div>
                <div class="card-body">
                    <!-- Auto-save indicator -->
                    <div id="autosave-indicator" class="alert alert-info d-none">
                        <i class="fas fa-save"></i> Changes saved automatically
                    </div>

                    <!-- Form for current step -->
                    <form id="wizard-step-form" method="post">
                        {% csrf_token %}
                        
                        {% if current_step == 1 %}
                            <!-- Personal Information -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.first_name.label_tag }}
                                    {{ form.first_name }}
                                    {% if form.first_name.errors %}
                                        <div class="text-danger small">{{ form.first_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.last_name.label_tag }}
                                    {{ form.last_name }}
                                    {% if form.last_name.errors %}
                                        <div class="text-danger small">{{ form.last_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.email.label_tag }}
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <div class="text-danger small">{{ form.email.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.mobile_phone.label_tag }}
                                    {{ form.mobile_phone }}
                                    {% if form.mobile_phone.errors %}
                                        <div class="text-danger small">{{ form.mobile_phone.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.address_line_1.label_tag }}
                                    {{ form.address_line_1 }}
                                    {% if form.address_line_1.errors %}
                                        <div class="text-danger small">{{ form.address_line_1.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.city.label_tag }}
                                    {{ form.city }}
                                    {% if form.city.errors %}
                                        <div class="text-danger small">{{ form.city.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.state_region.label_tag }}
                                    {{ form.state_region }}
                                    {% if form.state_region.errors %}
                                        <div class="text-danger small">{{ form.state_region.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.country.label_tag }}
                                    {{ form.country }}
                                    {% if form.country.errors %}
                                        <div class="text-danger small">{{ form.country.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.linkedin_url.label_tag }}
                                    {{ form.linkedin_url }}
                                    {% if form.linkedin_url.errors %}
                                        <div class="text-danger small">{{ form.linkedin_url.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.portfolio_url.label_tag }}
                                    {{ form.portfolio_url }}
                                    {% if form.portfolio_url.errors %}
                                        <div class="text-danger small">{{ form.portfolio_url.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                        {% elif current_step == 2 %}
                            <!-- Professional Summary -->
                            <div class="row">
                                <div class="col-12 mb-3">
                                    {{ form.professional_summary.label_tag }}
                                    {{ form.professional_summary }}
                                    <div class="form-text">
                                        Write a compelling 2-3 sentence summary highlighting your key strengths and career objectives.
                                    </div>
                                    {% if form.professional_summary.errors %}
                                        <div class="text-danger small">{{ form.professional_summary.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.experience_level.label_tag }}
                                    {{ form.experience_level }}
                                    {% if form.experience_level.errors %}
                                        <div class="text-danger small">{{ form.experience_level.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                        {% elif current_step == 3 %}
                            <!-- Skills -->
                            <div class="row">
                                <div class="col-12 mb-4">
                                    {{ form.technical_skills.label_tag }}
                                    {{ form.technical_skills }}
                                    <div class="form-text">
                                        List your technical skills separated by commas. Examples: Python, JavaScript, React, AWS, SQL
                                    </div>
                                    {% if form.technical_skills.errors %}
                                        <div class="text-danger small">{{ form.technical_skills.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 mb-4">
                                    {{ form.soft_skills.label_tag }}
                                    {{ form.soft_skills }}
                                    <div class="form-text">
                                        List your soft skills separated by commas. Examples: Leadership, Communication, Problem-solving
                                    </div>
                                    {% if form.soft_skills.errors %}
                                        <div class="text-danger small">{{ form.soft_skills.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 mb-3">
                                    {{ form.certifications.label_tag }}
                                    {{ form.certifications }}
                                    <div class="form-text">
                                        List any relevant certifications, licenses, or credentials.
                                    </div>
                                    {% if form.certifications.errors %}
                                        <div class="text-danger small">{{ form.certifications.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Skill Suggestions -->
                            <div class="skill-suggestions">
                                <h6 class="mb-3">Popular Skills (click to add):</h6>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <span class="badge bg-outline-primary skill-suggestion" data-type="technical">Python</span>
                                    <span class="badge bg-outline-primary skill-suggestion" data-type="technical">JavaScript</span>
                                    <span class="badge bg-outline-primary skill-suggestion" data-type="technical">React</span>
                                    <span class="badge bg-outline-primary skill-suggestion" data-type="technical">Node.js</span>
                                    <span class="badge bg-outline-primary skill-suggestion" data-type="technical">AWS</span>
                                    <span class="badge bg-outline-primary skill-suggestion" data-type="technical">Docker</span>
                                    <span class="badge bg-outline-primary skill-suggestion" data-type="technical">SQL</span>
                                    <span class="badge bg-outline-primary skill-suggestion" data-type="technical">Git</span>
                                </div>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="badge bg-outline-secondary skill-suggestion" data-type="soft">Leadership</span>
                                    <span class="badge bg-outline-secondary skill-suggestion" data-type="soft">Communication</span>
                                    <span class="badge bg-outline-secondary skill-suggestion" data-type="soft">Problem Solving</span>
                                    <span class="badge bg-outline-secondary skill-suggestion" data-type="soft">Team Collaboration</span>
                                    <span class="badge bg-outline-secondary skill-suggestion" data-type="soft">Project Management</span>
                                    <span class="badge bg-outline-secondary skill-suggestion" data-type="soft">Critical Thinking</span>
                                </div>
                            </div>

                        {% elif current_step == 4 %}
                            <!-- Work Experience -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.job_title.label_tag }}
                                    {{ form.job_title }}
                                    {% if form.job_title.errors %}
                                        <div class="text-danger small">{{ form.job_title.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.company_name.label_tag }}
                                    {{ form.company_name }}
                                    {% if form.company_name.errors %}
                                        <div class="text-danger small">{{ form.company_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.company_location.label_tag }}
                                    {{ form.company_location }}
                                    {% if form.company_location.errors %}
                                        <div class="text-danger small">{{ form.company_location.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.employment_type.label_tag }}
                                    {{ form.employment_type }}
                                    {% if form.employment_type.errors %}
                                        <div class="text-danger small">{{ form.employment_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.start_date.label_tag }}
                                    {{ form.start_date }}
                                    {% if form.start_date.errors %}
                                        <div class="text-danger small">{{ form.start_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.end_date.label_tag }}
                                    {{ form.end_date }}
                                    <div class="form-check mt-2">
                                        {{ form.currently_working }}
                                        <label class="form-check-label" for="{{ form.currently_working.id_for_label }}">
                                            Currently working here
                                        </label>
                                    </div>
                                    {% if form.end_date.errors %}
                                        <div class="text-danger small">{{ form.end_date.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 mb-3">
                                    {{ form.key_responsibilities.label_tag }}
                                    {{ form.key_responsibilities }}
                                    <div class="form-text">
                                        List your main responsibilities and duties in bullet points.
                                    </div>
                                    {% if form.key_responsibilities.errors %}
                                        <div class="text-danger small">{{ form.key_responsibilities.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 mb-3">
                                    {{ form.key_achievements.label_tag }}
                                    {{ form.key_achievements }}
                                    <div class="form-text">
                                        Highlight specific achievements, metrics, awards, or notable projects.
                                    </div>
                                    {% if form.key_achievements.errors %}
                                        <div class="text-danger small">{{ form.key_achievements.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>

                        {% elif current_step == 5 %}
                            <!-- Education -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    {{ form.degree_type.label_tag }}
                                    {{ form.degree_type }}
                                    {% if form.degree_type.errors %}
                                        <div class="text-danger small">{{ form.degree_type.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.field_of_study.label_tag }}
                                    {{ form.field_of_study }}
                                    {% if form.field_of_study.errors %}
                                        <div class="text-danger small">{{ form.field_of_study.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.institution_name.label_tag }}
                                    {{ form.institution_name }}
                                    {% if form.institution_name.errors %}
                                        <div class="text-danger small">{{ form.institution_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.institution_location.label_tag }}
                                    {{ form.institution_location }}
                                    {% if form.institution_location.errors %}
                                        <div class="text-danger small">{{ form.institution_location.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.graduation_year.label_tag }}
                                    {{ form.graduation_year }}
                                    {% if form.graduation_year.errors %}
                                        <div class="text-danger small">{{ form.graduation_year.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6 mb-3">
                                    {{ form.gpa_grade.label_tag }}
                                    {{ form.gpa_grade }}
                                    <div class="form-text">
                                        Optional: GPA, final grade, or class rank
                                    </div>
                                    {% if form.gpa_grade.errors %}
                                        <div class="text-danger small">{{ form.gpa_grade.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 mb-3">
                                    {{ form.relevant_coursework.label_tag }}
                                    {{ form.relevant_coursework }}
                                    <div class="form-text">
                                        List relevant courses, projects, or specializations.
                                    </div>
                                    {% if form.relevant_coursework.errors %}
                                        <div class="text-danger small">{{ form.relevant_coursework.errors.0 }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 mb-3">
                                    {{ form.academic_achievements.label_tag }}
                                    {{ form.academic_achievements }}
                                    <div class="form-text">
                                        Dean's List, scholarships, academic awards, honors, etc.
                                    </div>
                                    {% if form.academic_achievements.errors %}
                                        <div class="text-danger small">{{ form.academic_achievements.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- Navigation Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <div>
                                {% if current_step > 1 %}
                                    <a href="?step={{ current_step|add:'-1' }}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left"></i> Previous
                                    </a>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex gap-2">
                                <!-- Save as Draft Button -->
                                <button type="button" class="btn btn-outline-warning" id="save-draft-btn">
                                    <i class="fas fa-save"></i> Save as Draft
                                </button>
                                
                                {% if current_step < 5 %}
                                    <!-- Skip/Next Button (no validation) -->
                                    <a href="?step={{ current_step|add:'1' }}" class="btn btn-outline-primary">
                                        Skip <i class="fas fa-arrow-right"></i>
                                    </a>
                                    <!-- Save & Next Button (with validation) -->
                                    <button type="submit" class="btn btn-primary" id="next-btn">
                                        Save & Next <i class="fas fa-arrow-right"></i>
                                    </button>
                                {% else %}
                                    <!-- Final Save Button (with full validation) -->
                                    <button type="submit" class="btn btn-success" id="finish-btn">
                                        <i class="fas fa-check"></i> Save & Complete CV
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="mt-4">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="mb-3">
                            <i class="fas fa-lightbulb text-warning"></i> 
                            {% if current_step == 1 %}Tips for Personal Information
                            {% elif current_step == 2 %}Tips for Professional Summary
                            {% elif current_step == 3 %}Tips for Skills
                            {% elif current_step == 4 %}Tips for Work Experience
                            {% elif current_step == 5 %}Tips for Education
                            {% endif %}
                        </h6>
                        <ul class="mb-0 small">
                            {% if current_step == 1 %}
                                <li>Use a professional email address</li>
                                <li>Include your city and state/country</li>
                                <li>LinkedIn URL should be your custom URL if available</li>
                            {% elif current_step == 2 %}
                                <li>Keep it concise - 2-3 sentences maximum</li>
                                <li>Focus on your key strengths and value proposition</li>
                                <li>Avoid generic statements - be specific about what you offer</li>
                            {% elif current_step == 3 %}
                                <li>List skills relevant to your target positions</li>
                                <li>Include both hard skills (technical) and soft skills</li>
                                <li>Use industry-standard terminology</li>
                            {% elif current_step == 4 %}
                                <li>Start with your most recent position</li>
                                <li>Use action verbs and quantify achievements when possible</li>
                                <li>Focus on accomplishments, not just responsibilities</li>
                            {% elif current_step == 5 %}
                                <li>Include degree, institution, and graduation year</li>
                                <li>Mention relevant coursework for recent graduates</li>
                                <li>Include GPA only if it's 3.5 or higher</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Wizard Progress Styling */
.wizard-progress .step-item {
    position: relative;
}

.wizard-progress .step-item:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 20px;
    left: 50%;
    right: -50%;
    height: 2px;
    background-color: var(--border-color);
    z-index: 1;
}

.wizard-progress .step-item.completed:not(:last-child)::after {
    background-color: var(--success-state);
}

.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    background-color: var(--bg-secondary);
    border: 2px solid var(--border-color);
    color: var(--text-muted);
    font-weight: bold;
    position: relative;
    z-index: 2;
}

.step-item.active .step-circle {
    background-color: var(--btn-primary-bg);
    border-color: var(--btn-primary-bg);
    color: var(--btn-primary-text);
}

.step-item.completed .step-circle {
    background-color: var(--success-state);
    border-color: var(--success-state);
    color: white;
}

.step-label {
    display: block;
    color: var(--text-muted);
    font-weight: 500;
}

.step-item.active .step-label {
    color: var(--btn-primary-bg);
    font-weight: 600;
}

.step-item.completed .step-label {
    color: var(--success-state);
}

/* Step Navigation Links */
.step-link {
    text-decoration: none;
    display: block;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.step-link:hover {
    text-decoration: none;
    transform: translateY(-2px);
}

.step-link:hover .step-circle {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.step-link:hover .step-label {
    color: var(--btn-primary-bg);
}

/* Preserve active and completed states for linked steps */
.step-item.active .step-link .step-circle,
.step-item.active .step-link:hover .step-circle {
    background-color: var(--btn-primary-bg);
    border-color: var(--btn-primary-bg);
    color: var(--btn-primary-text);
}

.step-item.completed .step-link .step-circle,
.step-item.completed .step-link:hover .step-circle {
    background-color: var(--success-state);
    border-color: var(--success-state);
    color: white;
}

.step-item.active .step-link .step-label,
.step-item.active .step-link:hover .step-label {
    color: var(--btn-primary-bg);
}

.step-item.completed .step-link .step-label,
.step-item.completed .step-link:hover .step-label {
    color: var(--success-state);
}

/* Progress Bar */
.progress {
    height: 6px;
    background-color: var(--progress-bg);
}

.progress-bar {
    background-color: var(--btn-primary-bg);
    transition: width 0.6s ease;
}

/* Skill Suggestions */
.skill-suggestions {
    padding: 1rem;
    background-color: var(--bg-secondary);
    border-radius: 8px;
    margin-top: 1rem;
}

.skill-suggestion {
    cursor: pointer;
    transition: all var(--transition-fast);
    border: 1px solid var(--border-color);
    background-color: var(--bg-primary);
    color: var(--text-primary);
}

.skill-suggestion:hover {
    background-color: var(--btn-primary-bg);
    color: white;
    transform: translateY(-1px);
}

/* Form Styling */
.form-control,
.form-select {
    background-color: var(--input-bg);
    border-color: var(--input-border);
    color: var(--text-primary);
}

.form-control:focus,
.form-select:focus {
    border-color: var(--input-focus-border);
    box-shadow: var(--input-focus-shadow);
}

/* Card Styling */
.card {
    border: 1px solid var(--card-border);
    background-color: var(--card-bg);
    box-shadow: var(--card-shadow);
}

.card-header {
    background-color: var(--btn-primary-bg);
    border-bottom: 1px solid var(--border-color);
}

/* Auto-save indicator */
#autosave-indicator {
    background-color: var(--alert-success-bg);
    border-color: var(--success-state);
    color: var(--success-state);
}

/* Responsive Design */
@media (max-width: 768px) {
    .wizard-progress .step-item {
        margin-bottom: 1rem;
    }
    
    .wizard-progress .step-item:not(:last-child)::after {
        display: none;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    .step-label {
        font-size: 0.75rem;
    }
}

/* Gap utility classes */
.gap-2 {
    gap: 0.5rem;
}

.gap-3 {
    gap: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('wizard-step-form');
    const autosaveIndicator = document.getElementById('autosave-indicator');
    let autosaveTimeout;
    const currentStep = {{ current_step }};
    
    // Auto-save functionality
    function setupAutosave() {
        const inputs = form.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(autosaveTimeout);
                autosaveTimeout = setTimeout(saveProgress, 2000); // Save after 2 seconds of inactivity
            });
        });
    }
    
    async function saveProgress() {
        const formData = new FormData(form);
        formData.append('step', currentStep);
        
        try {
            const response = await fetch('{% url "jobassistant:save_wizard_step" %}', {
                method: 'POST',
                body: JSON.stringify({
                    step: currentStep,
                    form_data: Object.fromEntries(formData.entries())
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            if (response.ok) {
                showAutosaveIndicator();
            }
        } catch (error) {
            console.error('Auto-save failed:', error);
        }
    }
    
    function showAutosaveIndicator() {
        autosaveIndicator.classList.remove('d-none');
        setTimeout(() => {
            autosaveIndicator.classList.add('d-none');
        }, 2000);
    }
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        formData.append('step', currentStep);
        
        try {
            const response = await fetch('{% url "jobassistant:save_wizard_step" %}', {
                method: 'POST',
                body: JSON.stringify({
                    step: currentStep,
                    form_data: Object.fromEntries(formData.entries())
                }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                if (currentStep < 5) {
                    // Go to next step
                    window.location.href = `?step=${currentStep + 1}`;
                } else {
                    // Wizard complete, redirect to profile
                    showNotification('CV created successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/cv/profile/' + data.profile_id + '/';
                    }, 1000);
                }
            } else {
                showNotification('Error saving step: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            showNotification('Error: ' + error.message, 'error');
        }
    });
    
    // Save as Draft functionality
    const saveDraftBtn = document.getElementById('save-draft-btn');
    if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', async function() {
            const formData = new FormData(form);
            formData.append('step', currentStep);
            formData.append('save_as_draft', 'true');
            
            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            this.disabled = true;
            
            try {
                const response = await fetch('{% url "jobassistant:save_wizard_step" %}', {
                    method: 'POST',
                    body: JSON.stringify({
                        step: currentStep,
                        form_data: Object.fromEntries(formData.entries()),
                        save_as_draft: true
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Draft saved successfully!', 'success');
                } else {
                    showNotification('Error saving draft: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            } finally {
                // Restore button state
                this.innerHTML = originalText;
                this.disabled = false;
            }
        });
    }
    
    // Skill suggestions
    document.querySelectorAll('.skill-suggestion').forEach(skill => {
        skill.addEventListener('click', function() {
            const skillName = this.textContent;
            const skillType = this.dataset.type;
            
            let targetField;
            if (skillType === 'technical') {
                targetField = form.querySelector('[name="technical_skills"]');
            } else {
                targetField = form.querySelector('[name="soft_skills"]');
            }
            
            if (targetField) {
                let currentValue = targetField.value;
                if (currentValue && !currentValue.endsWith(', ')) {
                    currentValue += ', ';
                }
                
                if (!currentValue.includes(skillName)) {
                    targetField.value = currentValue + skillName;
                    this.style.opacity = '0.5';
                    this.style.pointerEvents = 'none';
                    
                    // Trigger auto-save
                    clearTimeout(autosaveTimeout);
                    autosaveTimeout = setTimeout(saveProgress, 500);
                }
            }
        });
    });
    
    // Initialize auto-save
    setupAutosave();
});
</script>
{% endblock %}
